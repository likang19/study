### Eureka的实现原理

~~~
大概就三种实现方法：
1.服务与注册发现：当一个服务实例启动时，它会向Eureka Server发送注册请求，将自己的信息注册到注册中心。Eureka Server会将这些信息保存在内存中
2.服务健康检查：Eureka通过心跳机制来检测服务实例的健康状态
3.负载均衡：Eureka客户端在调用其他服务时，会从本地缓存中获取服务的注册信息
~~~

## Eureka Server怎么保证高可用

~~~
主要从三个方面实现：
1.多实例部署：通过将多个eureka Service 部署在不同的节点，可以实现高可用，当一台发生故障时，其它的可以用
2.服务注册的复制：当一个服务实例向service注册时，每个eureka Service 实例都会复制其它实例的信息，以保持数据一致性，当一个发生故障时其它节点接管工作
3.自我保护机制：当节点在一定时间内没有接收到心跳时，它会进入自我保护机制，当进入自我保护机制模式下，不在剔除注册中的服务实例，以保护现有注册信息，这样可以防止由于网络抖动或者其它原因引起的原因剔除，进一步提高系统稳定性
~~~

### 心跳与故障检测

~~~
	服务注册中心还有一个很重要的功能就是 心跳与故障检查。心跳跟故障检测其实就是为了知道注册上来的这些服务是不是还活着的。EurekaClient作为java客户端，在服务启动后周期性的（默认30s）向EurekaServer发送心跳包，若在一定时间内未收到心跳包，则会从服务注册表移除该实例。
	发送心跳包也被称为续约。 通过续约来告知Eureka Server该Eureka客户仍然存在，没有出现问题。 正常情况下，如果Eureka Server在90秒没有收到Eureka客户的续约，它会将实例从其注册表中删除。 建议不要更改续约间隔。
	当出现机器故障没有在约定的时间（90秒）间隔内上报自己的状态，那么Eureka 就会把这台机器剔除注册表，同时更新到 ReadWrite 缓存中去
~~~

## EurekaClient会缓存注册表信息

~~~
ureka客户端从服务器获取注册表信息，并将其缓存在本地。客户端会使用该信息查找其他服务，从而进行远程调用。每次返回注册列表信息可能与Eureka客户端的缓存信息不同， Eureka客户端自动处理。
~~~

## EurekaServer之间会相互复制注册表信息

~~~
Eureka server端提供服务注册，服务信息提供，服务管理（通过Eureka Client的Cancel、心跳监控、renew等方式来维护该服务提供的信息以确保该服务可用以及服务的更新
在eureka server端集群环境下，各个服务端的注册表信息会互相复制，从而确保节点中数据一致。但在页面上看，只有主服务能看到全部服务连接信息，从服务只能看到主服务的连接信息；
多个Eureka Server之间通过P2P复制的方式完成服务注册表的同步。同步时，被同步信息不会同步出去。也就是说有3个Eureka Server，Server1有新的服务信息时，同步到Server2后，Server2和Server3同步时，Server2不会把从Server1那里同步到的信息同步给Server3，只能由Server1自己同步给Server3。
~~~

## 一级缓存和二级缓存

~~~
当服务在拉取服务注册表的时候，其实客户端不是直接从 Eureka 中的 服务注册表中获取数据的。Eureka 做了二级缓存，第一级叫做 ReadOnly 缓存，二级叫做 ReadWrite 缓存，客户端会直接从ReadOnly 缓存中读取注册表信息。当服务在进行注册的时候，先往服务注册表中写入注册信息，服务注册表更新了，立马会同步一份数据到 ReadWrite 缓存中去。
那什么时候 ReadWrite 缓存中的数据会到 ReadOnly 缓存中去?
此时有一个定时任务会定时去检查 ReadWrite 是否跟 ReadOnly 不一致,不一致就把数据同步到 ReadOnly 中去。这个定时任务也默认是 30S。也可以自己配置。二级缓存的好处在于，优化并发读写的冲突。

~~~

# Eviction 服务剔除

~~~
在默认的情况下，当Eureka客户端连续90秒没有向Eureka服务器发送服务续约，即心跳，Eureka服务器会将该服务实例从服务注册列表删除，即服务剔除。
~~~

# 自我保护机制

~~~
Eureka Server 在检测到心跳异常后会将服务实例保护起来，让这些实例不会马上过期，自我保护机制的工作机制是如果在15分钟内超过85%的客户端节点都没有正常的心跳，那么Eureka就认为客户端与注册中心出现了网络故障，Eureka Server自动进入自我保护机制，此时会出现以下几种情况：
1.Eureka Server不再从注册列表中移除因为长时间没收到心跳而应该过期的服务。
2.Eureka Server仍然能够接受新服务的注册和查询请求，但是不会被同步到其它节点上，保证当前节点依然可用。\
3.当网络稳定时，当前Eureka Server新的注册信息会被同步到其它节点中。
但是在保护期内如果服务刚好这个服务提供者非正常下线了，此时服务消费者就会拿到一个无效的服务实例，此时会调用失败，对于这个问题需要服务消费者端要有一些容错机制，如重试，断路器等。
我们在单机测试的时候很容易满足心跳失败比例在 15 分钟之内低于 85%，这个时候就会触发 Eureka 的保护机制，一旦开启了保护机制，则服务注册中心维护的服务实例就不是那么准确了，此时我们可以关闭保护机制，这样可以确保注册中心中不可用的实例被及时的剔除
~~~

