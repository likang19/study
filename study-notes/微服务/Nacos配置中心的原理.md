## Nacos配置中心的原理

配置信息的CRUD

~~~
1.配置信息存储
2.注册配置信息
3.获取配置信息
4.监听配置变化
~~~

## Nacos配置中心长轮询机制

~~~
一般情况下，客户端与服务端交互方式：推(push)与拉(pull),nacos在pull的基础上，采用长轮询来进行配置的动态刷新
长轮询模式下，定时向服务端发送请求，检查配置是否发生变化，如果没有变化，服务端hold这个请求，不会返回结果
1.客户端发起Pull请求
2.在等待期间，如果配置发生变更，服务端会立即返回结果给客户端，完成一次"推送"操作。
3.如果在等待期间没有配置变更，等待时间达到预设的超时时间后，服务端会自动返回结果给客户端，即使配置没有变更。
4.如果在等待期间，通过Nacos Dashboard或API对配置进行了修改
~~~

### 长轮询与短轮询

~~~
短轮询也是拉模式：指不管服务端有没有数据更新，都会定期的去拉取一次数据，有可有更新数据也可能什么都没有
	问题：由于配置数据不会频繁的更新，若是一直发送请求，势必会对服务端有压力，还会对数据造成压力，比如：每10s拉一次，结果在11s的时候更新配置，那么延迟就会有9s
长轮询为解决短轮询的问题而生：
	客户端发起长轮询，如果服务端没有发生变化，会hold请求，直接服务端发送数据变化，在返回请求，返回后，客户端在发起下次请求监听
  好处:降低了延迟，服务端压力减少，hold时间一般会设置在30s或者60s,并且服务端hold住请求不会消耗太多资源
 
~~~

### 长轮询代码实现

参考地址：https://juejin.cn/post/7139005387461623845

### AsyncContext异步处理http请求

~~~
第一步，Servlet 接收到请求之后，可能首先需要对请求携带的数据进行一些预处理；
第二步，Servlet 线程将请求转交给一个异步线程来执行业务处理，线程本身返回至容器，
第三步，Servlet 还没有生成响应数据，异步线程处理完业务以后，可以直接生成响应数据（异步线程拥有 ServletRequest 和 ServletResponse 对象的引用），或者将请求继续转发给其它 Servlet。
Servlet 线程不再是一直处于阻塞状态以等待业务逻辑的处理，而是启动异步线程之后可以立即返回。
————————————————
版权声明：本文为CSDN博主「CRUD的W」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：https://blog.csdn.net/qq_31086797/article/details/108455482

~~~

### nacos 健康机制

~~~
nacos健康机制之前，一定nacos中的实例分类，nacos提供两种服务类型，分为临时实例与永久实例
	临时实例：临时存放在注册中心，会在服务下线或者不可用的的时候剔除。临时实例会与注册中心保持心跳
	永久实例：被删除之前永久保存在注册中心，有可能并不知道注册中心的存在，不会主动向注册中心发起心跳，那么这个时间就需要（注册中心）主动发起探活
什么是临时实例的健康检查机制？
	用户可以通过两种方法进行临时实例注册，openAPI注册或者SDK进行服务注册。
	一、OpenAPI是通过自身需求调用API，然后通过心跳注册中心，在注册服务的同时会注册一个全局客户端心跳任务，在服务一段时间后没有收到心跳标记为不健康，如果一段时间没有收到心跳会剔除。
	SDK注册是通过RPC与注册中心保持连接（2.x后使用的是RPC）， 客户端会定时的通过RPC连接向服务端注册发送心跳，如果客户端和注册中心断开，那么注册中心会剔除客户端健康状态。同时 Nacos 注册中心还会在注册中心启动时，注册一个过期客户端清除的定时任务
	定时器默认的周期为5s，业务服务可以在发起服务注册时，主动的调整健康检查心跳的周期
	二、永久实例健康检查机制
	Nacos 中使用 SDK 对于永久实例的注册实际也是使用 OpenAPI 的方式进行注册，这样可以保证即使是客户端下线后也不会影响永久实例的健康检查，
	对于永久实例的的监看检查，Nacos 采用的是注册中心探测机制，注册中心会在永久服务初始化时 根据客户端选择的协议类型注册探活的定时任务。Nacos 现在内置提供了三种探测的协议即 Http、TCP 以及 MySQL一般而言 Http 和 TCP 已经可以涵盖绝大多数的健康检查场景。MySQL 主要用于特殊的业务场景
	由于持久化服务的实例的在被主动删除前一直存在的特性，探活的定时任务会不断探测服务的健康状态，并且将无法探测成功的实例标记为不健康。但是有些时候会有这样的场景，有些服务不希望去校验其健康状态，Nacos 也是提供了对应的白名单配置，用户可以将服务配置到该白名单，那么 Nacos 会放弃对其进行健康检查，实例的健康状态也始终为用户传入的健康状态
	1.Nacos Server会启动一个定时任务，定时的执行任务HealthCheckTask，并调用永久实例健康检查机制的处理类HealthCheckProcessorDelegate去处理健康检查。
	2.Nacos Server服端的健康检查可以分为多种类型，比如MysqlHealthCheckProcessor、HttpHealthCheckProcessor和TcpSuperSenseProcessor等。
	3.HttpHealthCheckProcessor为Nacos支持的基于HTTP的永久实例健康检查机制的处理类，Tcp	SuperSenseProcessor为Nacos支持的基于TCP的永久实例健康检查机制的处理类，MysqlHealthCheckProcessor为Nacos支持的基于数据库健康检查的永久实例健康检查机制的处理类。
	
~~~

